---
title: "Data cleaning, set Two"
author: "Devinn Chi and Chris Lohmeier"
date: "2024-03-27"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, warning = FALSE, message = FALSE}
library(tidyverse)
library(dplyr)
library(readr)
library(jsonlite)
library(skimr)
library(lubridate)
library(ggpubr)
```


# Reading in kaggle steam dataset
```{r}
KsteamData <- read_csv("../data/data_raw/steam_games.csv")
```

# Overview of data
```{r}
skim(KsteamData)
KsteamData %>% pull(platforms) %>% unique()
```


#DEVINN CODE STARTS -----------------------------------------------------------------------------------------------------------------------

# cleaning - removing unwanted variables
```{r}
KsteamDataClean <- KsteamData %>% 
  select(-desc_snippet, -url, -recommended_requirements, -minimum_requirements, -game_description, -game_details, -popular_tags)
```

# cleaning - removing long values from reviews
```{r}
KsteamDataClean <- KsteamDataClean %>% 
  mutate(recent_positive_percent = str_extract(recent_reviews, "\\d+%"))

KsteamDataClean <- KsteamDataClean %>% 
  mutate(all_positive_percent = str_extract(all_reviews, "\\d+%"))

KsteamDataClean <- KsteamDataClean %>%
  mutate(recent_positive_percent = str_extract(recent_positive_percent, "\\d+")) %>% 
  mutate(all_positive_percent = str_extract(all_positive_percent, "\\d+"))

KsteamDataClean <- KsteamDataClean %>% 
  mutate(recent_positive_unumber = str_extract(recent_reviews, "\\d+"))

KsteamDataClean <- KsteamDataClean %>% 
  mutate(all_positive_unumber = str_extract(all_reviews, "\\d+"))

KsteamDataClean$recent_reviews <- 
  str_extract(KsteamDataClean$recent_reviews, "(?i)Overwhelmingly Positive|Very Positive|Positive|Mostly Positive|Mixed|Mostly Negative|Negative|Very Negative|Overwhelmingly Negative")

KsteamDataClean$all_reviews <- 
  str_extract(KsteamDataClean$all_reviews, "(?i)Overwhelmingly Positive|Very Positive|Positive|Mostly Positive|Mixed|Mostly Negative|Negative|Very Negative|Overwhelmingly Negative")
```

# cleaning - removing na values from reviews
```{r}
KsteamDataClean <- KsteamDataClean %>%
  filter(!is.na(recent_reviews) == TRUE)

KsteamDataClean <- KsteamDataClean %>%
  filter(!is.na(all_reviews) == TRUE)
```

# cleaning - changing prices to numeric values
```{r}
KsteamDataClean <- KsteamDataClean %>% 
  mutate(original_price = ifelse(str_detect(original_price, "Free"), 0, as.numeric(str_replace_all(original_price, "[^0-9.]+", ""))))
```


# vizualizations
```{r}
achievementsPrice <- ggplot(KsteamDataClean) +
  geom_point(aes(x = achievements, y = original_price)) +
  theme_classic() +
  lims(x = c(0, 100))
  
# run to show graph
# achievementsPrice

# No correlation between price and number of achievements



```


# @Chris, removing the NA values from the reviews columns leaves us with like a little over 2000 cases, which I find kinda strange but whateva

#DEVINN CODE ENDS  ------------------------------------------------------------------------------------------------------------------------


# CHRIS CODE BEGINS

# Widen genres
```{r}
KsteamDataGenres <- KsteamDataClean %>% 
  mutate(genres = str_split(genre, ",")) %>% 
  unnest(cols = c(genres)) %>% 
  select(-genre) %>% 
  pivot_wider(names_from = genres, values_from = genres) %>% 
  mutate(across(.cols = colnames(.)[17:42], function(x) {ifelse(str_detect(x, "NULL"), FALSE, TRUE)}))
```

# Run price to popularity analysis (TODO)
```{r}
genre_stats <- function(metric, source, genre) {
  data <- KsteamDataGenres %>%
    mutate(across(any_of(c(source, metric)), as.numeric)) %>% 
    filter(genre == genre) %>%
    drop_na(any_of(c(genre, source, metric))) %>% 
    select(any_of(c(source, metric)))
  
  mod <- lm(as.formula(str_c(metric, " ~ ", source)), data)
  
  stats <- list(
    genre = genre,
    source = source,
    coef = coef(mod)[2],
    max = confint(mod)[source, "97.5 %"],
    min = confint(mod)[source, "2.5 %"],
    cor = cor(data)[source, metric]
  )
  return(stats)
}

# Test case
genre_stats(metric = "original_price", source = "all_positive_percent", genre = "Action")

# genres <- colnames(KsteamDataGenres)[17:41] 
# To get all genres

genres <- c("Action", "Adventure", "Casual", "Racing", "Indie", "RPG", "Simulation")
sources <- c("recent_positive_percent", "recent_positive_unumber", "all_positive_percent", "all_positive_unumber")
inputs <- expand_grid(genres, sources)

pop_price_genre <- map2(inputs$sources, inputs$genres, genre_stats, metric = "original_price") %>%
  bind_rows()
```

```{r}
pop_price_genre %>% 
  ggplot() +
    geom_bar(aes(x = genre, y = coef, fill = source, color = source), position = "dodge", alpha = 0.5, stat = "identity") +
    geom_errorbar(aes(x = genre, ymin = min, ymax = max, color = source), position = "dodge") +
    theme_classic()
```








